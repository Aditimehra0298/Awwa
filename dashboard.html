<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWWA - Dashboard Home</title>
    <link rel="stylesheet" href="dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <header class="app-header">
        <div class="app-header-inner">
            <div class="app-brand">
                <img src="public/Awwa2-logo.png" alt="AWWA Logo" class="app-logo" />
                <div class="app-title-wrap">
                    <h1 class="app-title">AWWA Family Management System</h1>
                    <div class="app-subtitle">‚Äò‡§¶‡•Ä‡§™‚Äô ü™î ‚Äî ‚òº ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ ‡§∏‡•á ‡§Ü‡§§‡•ç‡§Æ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞‡§§‡§æ ‚òº</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </header>
    <div class="dash-layout">
        <!-- Left Side Panel -->
        <aside class="left-panel">
            <div class="lp-header">
                <img src="public/profile.png" alt="Profile" class="lp-avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div class="lp-avatar" style="display:none;">SB</div>
                <div class="lp-name">Sushma Bhatti</div>
                <div class="lp-role">Battalion Command</div>
            </div>
            <nav class="lp-nav">
                <ul>
                    <li class="active" data-target="section-dashboard"><i class="fas fa-home"></i><span>Dashboard</span></li>
                    <li data-target="section-families"><i class="fas fa-notes-medical"></i><span>Families</span></li>
                    <li data-target="section-companies"><i class="fas fa-building"></i><span>COY</span></li>
                    <li data-target="section-Newsletter"><i class="fas fa-calendar"></i><span>Newsletter</span></li>
                    <li data-target="section-Rankings"><i class="fas fa-chart-bar"></i><span>Rankings</span></li>
                    <li data-target="section-settings"><i class="fas fa-gear"></i><span>Settings</span></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Area -->
        <div class="main-area">
    <div class="home-container app-section" id="section-dashboard">
        <!-- Welcome Header Row -->
        <section class="welcome-section-card">
            <h1 class="welcome-title" id="welcomeTitle">Welcome!</h1>

            <div class="user-grid">
                <!-- User Information -->
                <div class="panel-card">
                    <div class="panel-header">
                        <i class="fas fa-user-circle"></i>
                        <h3>User Information</h3>
                    </div>
                    <div class="panel-body" id="userInfoBody">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>

                <!-- Additional Details (empty) -->
                <div class="panel-card">
                    <div class="panel-header">
                        <i class="fas fa-circle-info"></i>
                        <h3>Additional Details</h3>
                    </div>
                    <div class="panel-body empty"></div>
                </div>

                <!-- Profile Card -->
                <div class="profile-side-card">
                    <img src="public/profile.png" alt="Profile" class="avatar-box-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                    <div class="avatar-box" style="display:none;" id="profileInitials">SB</div>
                    <i class="fas fa-check-circle verified"></i>
                    <div class="profile-meta">
                        <h4 id="profileName">Loading...</h4>
                        <p id="profileDesignation">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- System Statistics -->
        <section class="stats-section-home">
            <h2 class="section-title center">System Statistics & Analytics</h2>
            <div class="stats-toolbar">
                <div class="filter-chips" id="activeFilters">
                    <span class="chip" id="chipCoy" style="display:none"></span>
                    <span class="chip" id="chipYear" style="display:none"></span>
                </div>
                <span class="last-updated" id="lastUpdateTime">Last updated: just now</span>
            </div>
            <div class="stats-filters">
                <select id="filterCoy">
                    <option value="all">All COYs</option>
                    <option>832 Coy</option>
                    <option>265 Coy</option>
                    <option>290 Coy</option>
                    <option>831 Coy</option>
                    <option>286 Coy</option>
                    <option>288 Coy</option>
                </select>
                <select id="filterYear">
                    <option value="all">All Years</option>
                    <option>2023</option>
                    <option>2024</option>
                    <option>2025</option>
                </select>
            </div>
            
            <!-- Analytics Insights Section -->
            <div class="analytics-insights">
                <div class="insight-card">
                    <div class="insight-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>Key Insights</h3>
                    </div>
                    <div class="insight-content">
                        <div class="insight-item">
                            <span class="insight-label">Total Families:</span>
                            <span class="insight-value" id="totalFamilies">273</span>
                            <span class="insight-change" id="familiesChange">+12%</span>
                        </div>
                        <div class="insight-item">
                            <span class="insight-label">IVF Cases This Month:</span>
                            <span class="insight-value" id="ivfCases">6</span>
                            <span class="insight-change" id="ivfChange">+15%</span>
                        </div>
                        <div class="insight-item">
                            <span class="insight-label">Special Child Cases:</span>
                            <span class="insight-value" id="specialChildCases">2</span>
                            <span class="insight-change" id="specialChildChange">+8%</span>
                        </div>
                        <div class="insight-item">
                            <span class="insight-label">Critical Medical Cases:</span>
                            <span class="insight-value" id="criticalCases">0</span>
                            <span class="insight-change" id="criticalChange">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-header">
                        <i class="fas fa-trending-up"></i>
                        <h3>Trend Analysis</h3>
                    </div>
                    <div class="insight-content">
                        <div class="trend-item">
                            <div class="trend-indicator positive"></div>
                            <span class="trend-text">IVF treatments increased by 15% this quarter</span>
                        </div>
                        <div class="trend-item">
                            <div class="trend-indicator negative"></div>
                            <span class="trend-text">Marital discord cases down by 8%</span>
                        </div>
                        <div class="trend-item">
                            <div class="trend-indicator neutral"></div>
                            <span class="trend-text">Special child cases remain stable</span>
                        </div>
                        <div class="trend-item">
                            <div class="trend-indicator positive"></div>
                            <span class="trend-text">Family registrations up 12%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Summary & KPIs -->
            <div class="data-summary-section">
                <h3 class="summary-title">Key Performance Indicators</h3>
                <div class="kpi-grid">
                    <div class="kpi-card kpi-click" data-target="childrenClassChart" data-kind="families" title="View children distribution">
                        <div class="kpi-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="totalFamiliesKPI">150</div>
                            <div class="kpi-label">Total Families</div>
                            <div class="kpi-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+12% this month</span>
                            </div>
                            <canvas id="sparkFamilies" class="kpi-sparkline" height="36"></canvas>
                        </div>
                    </div>
                    
                    <div class="kpi-card kpi-click" data-target="childrenClassChart" data-kind="ivf" title="View children distribution">
                        <div class="kpi-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="ivfSuccessRate">78%</div>
                            <div class="kpi-label">IVF Success Rate</div>
                            <div class="kpi-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+5% improvement</span>
                            </div>
                            <canvas id="sparkIVF" class="kpi-sparkline" height="36"></canvas>
                        </div>
                    </div>
                    
                    <div class="kpi-card kpi-click" data-target="healthTreatmentChart" data-kind="special" title="View health & treatment cases">
                        <div class="kpi-icon">
                            <i class="fas fa-child"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="specialNeedsSupport">92%</div>
                            <div class="kpi-label">Special Needs Support</div>
                            <div class="kpi-trend neutral">
                                <i class="fas fa-minus"></i>
                                <span>Stable</span>
                            </div>
                            <canvas id="sparkSpecial" class="kpi-sparkline" height="36"></canvas>
                        </div>
                    </div>
                    
                    <div class="kpi-card kpi-click" data-target="occupationChart" data-kind="critical" title="View occupation breakdown">
                        <div class="kpi-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="criticalCasesResolved">85%</div>
                            <div class="kpi-label">Critical Cases Resolved</div>
                            <div class="kpi-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+8% this quarter</span>
                            </div>
                            <canvas id="sparkCritical" class="kpi-sparkline" height="36"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Drilldown Modal -->
            <div id="drilldownModal" class="drill-modal" style="display:none">
                <div class="drill-dialog">
                    <div class="drill-header">
                        <h3 id="drillTitle">Details</h3>
                        <button class="drill-close" id="drillClose" aria-label="Close"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="drill-toolbar">
                        <input id="drillSearch" class="drill-search" placeholder="Search..." />
                        <span id="drillCount" class="drill-count">0 rows</span>
                    </div>
                    <div class="drill-body">
                        <table class="drill-table">
                            <thead id="drillThead"></thead>
                            <tbody id="drillTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="stats-card-grid">
                <div class="stat-mini-card">
                    <div class="mini-icon"><i class="fas fa-people-group"></i><span class="mini-badge" id="badgeFamilies">0</span></div>
                    <div class="mini-meta">
                        <span class="mini-label">TOTAL FAMILIES</span>
                        <div class="mini-value" id="totalFamiliesVal">274</div>
                        <small>Registered families in the system</small>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="mini-icon"><i class="fas fa-child-reaching"></i><span class="mini-badge" id="badgeChildren">0</span></div>
                    <div class="mini-meta">
                        <span class="mini-label">TOTAL CHILDREN</span>
                        <div class="mini-value" id="totalChildrenVal">509</div>
                        <small>Children across all families</small>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="mini-icon"><i class="fas fa-square-check"></i><span class="mini-badge" id="badgeRegistered">0</span></div>
                    <div class="mini-meta">
                        <span class="mini-label">REGISTERED FAMILIES</span>
                        <div class="mini-value" id="registeredFamiliesVal">274</div>
                        <small>100% of total</small>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="mini-icon"><i class="fas fa-chart-column"></i><span class="mini-badge" id="badgeAvg">1</span></div>
                    <div class="mini-meta">
                        <span class="mini-label">AVG CHILDREN/FAMILY</span>
                        <div class="mini-value" id="avgChildrenVal">1.9</div>
                        <small>Average children per family</small>
                    </div>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>Children by Class & Special Needs</h3><div id="sub-children" class="chart-subtitle"></div></div>
                    <canvas id="childrenClassChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>Family Health & Treatment Cases</h3><div id="sub-health" class="chart-subtitle"></div></div>
                    <canvas id="healthTreatmentChart"></canvas>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>Husband & Ladies Occupation</h3><div id="sub-occupation" class="chart-subtitle"></div></div>
                    <canvas id="occupationChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>Qualification & Joining Date</h3></div>
                    <canvas id="qualificationChart"></canvas>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>IVF Starts per Month</h3></div>
                    <canvas id="ivfStartsChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>IVF Treatment Status</h3></div>
                    <canvas id="ivfStatusChart"></canvas>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>Special Child vs Normal Medical Cases</h3></div>
                    <canvas id="specialVsNormalChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>Special Child ‚Äì Disability Breakdown</h3></div>
                    <canvas id="disabilityBreakdownChart"></canvas>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>Marital Discord ‚Äì Official vs Not Official</h3></div>
                    <canvas id="maritalDiscordChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>Marital Discord ‚Äì Total Breakdown</h3></div>
                    <canvas id="maritalDiscordTotalChart"></canvas>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>Family Critical Medical Problem</h3></div>
                    <canvas id="familyCriticalChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>Family Critical ‚Äì Details</h3></div>
                    <div style="padding:8px;color:#7f8c8d;">No critical medical problems reported (Nil).</div>
                </div>
            </div>
            <div class="stats-charts-row">
                <div class="chart-card">
                    <div class="chart-header"><h3>Low Medical Category ‚Äì Present Med Cat</h3></div>
                    <canvas id="lowMedCatChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3>Low Med ‚Äì Critical vs Normal</h3></div>
                    <canvas id="lowMedCriticalPie"></canvas>
                </div>
            </div>
        </section>

        <!-- Bottom Summary Row -->
        <section class="summary-row">
            <div class="summary-card">
                <h3>Data Summary</h3>
                <div class="summary-item">
                    <span class="s-label">Data Completeness:</span>
                    <span class="s-value high">High</span>
                </div>
                <div class="summary-item">
                    <span class="s-label">Total Records:</span>
                    <span class="s-value">783</span>
                </div>
            </div>
            <div class="summary-card">
                <h3>Children Breakdown</h3>
                <div class="summary-item">
                    <span class="s-label">Special Needs:</span>
                    <span class="s-value">0 children</span>
                </div>
                <div class="summary-item">
                    <span class="s-label">With Medical Info:</span>
                    <span class="s-value">0 children</span>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Placeholder sections for navigation (hidden by default) -->
    <div class="families-section app-section hidden" id="section-families">
        <div class="section-header-row">
            <h2>Families <span class="count">(20)</span></h2>
            <div class="families-actions">
                <input type="text" class="fam-search" placeholder="Search families..." />
                <button class="check-btn">Add Family</button>
            </div>
        </div>
        <div class="families-grid" id="familiesGrid"></div>
    </div>
    <div class="coy-section app-section hidden" id="section-companies">
        <div class="section-header-row">
            <h2>COY <span class="count">(24)</span></h2>
            <div class="coy-actions">
                <input type="text" class="fam-search" placeholder="Search COY..." />
                <button class="check-btn">Add COY</button>
            </div>
        </div>
        <div class="coy-grid" id="coyGrid"></div>
    </div>
    <div class="newsletter-section app-section hidden" id="section-Newsletter">
        <div class="section-header-row">
            <h2>Newsletter</h2>
            <div class="families-actions">
                <a href="#subscribe" class="check-btn">Go to Subscribe</a>
            </div>
        </div>
        <div class="newsletter-grid">
            <div class="newsletter-card">
                <h3>Subscribe to AWWA Updates</h3>
                <p class="subtext">Get monthly highlights, events, and community stories right in your inbox.</p>
                <form id="newsletterForm" class="newsletter-form">
                    <div class="form-row">
                        <label for="nlName">Full name</label>
                        <input type="text" id="nlName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-row">
                        <label for="nlEmail">Email address</label>
                        <input type="email" id="nlEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-row inline">
                        <input type="checkbox" id="nlConsent" required>
                        <label for="nlConsent">I agree to receive newsletters and understand I can unsubscribe anytime.</label>
                    </div>
                    <button type="submit" class="check-btn wide">Subscribe</button>
                    <p id="nlMessage" class="nl-message" aria-live="polite"></p>
                </form>
            </div>

            <div class="newsletter-side">
                <div class="nl-info">
                    <h4>What you'll get</h4>
                    <ul>
                        <li>Monthly digest of AWWA activities</li>
                        <li>Upcoming events & workshops</li>
                        <li>Success stories from our community</li>
                        <li>Volunteer opportunities</li>
                    </ul>
                </div>
                <div class="nl-share">
                    <h4>Share subscription link</h4>
                    <div class="share-row">
                        <input type="text" id="nlShareLink" readonly value="https://awwa.example.com/newsletter/subscribe">
                        <button class="copy-btn" id="copyLinkBtn" type="button"><i class="fas fa-copy"></i></button>
                    </div>
                    <small>Copy this link to invite others to join the newsletter.</small>
                </div>
            </div>
        </div>
    </div>
    <div class="powerbi-section app-section hidden" id="section-reports">
        <div class="section-header-row">
            <h2>Analytics (Power BI)</h2>
            <div class="families-actions">
                <a href="https://learn.microsoft.com/power-bi/collaborate-share/service-publish-to-web" target="_blank" class="check-btn">How to get embed link</a>
            </div>
        </div>
        <div class="powerbi-grid">
            <div class="powerbi-config">
                <h3>Embed your report</h3>
                <p class="subtext">Paste a Power BI "Publish to web" URL (starts with https://app.powerbi.com/view?...). We'll remember it for you.</p>
                <div class="form-row">
                    <label for="pbiUrl">Power BI public embed URL</label>
                    <input id="pbiUrl" type="url" placeholder="https://app.powerbi.com/view?r=..." />
                </div>
                <div class="form-row inline">
                    <button id="pbiLoadBtn" class="check-btn">Load report</button>
                    <button id="pbiClearBtn" class="copy-btn" type="button">Clear</button>
                </div>
                <small>Note: For secure embeds (Embed for your organization) you'll need a backend to generate an access token. This UI supports public "Publish to web" links for quick demos.</small>
            </div>
            <div class="powerbi-view">
                <div class="pbi-frame-wrap">
                    <iframe id="pbiFrame" title="Power BI Report" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>
    <div class="ranking-section app-section hidden" id="section-Rankings">
        <div class="section-header-row">
            <h2>Unit Rankings</h2>
        </div>
        <div class="ranking-grid">
            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">1</div>
                    <img src="public/Gemini_Generated_Image_4jitd24jitd24jit.png" alt="Col Tarunpreet Singh" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Col</div>
                    <h3 class="rank-name">Tarunpreet Singh</h3>
                    <div class="rank-role">Commanding Officer</div>
                    <a href="tel:9650300475" class="rank-phone">Mob No: 9650300475</a>
                </div>
            </div>

            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">2</div>
                    <img src="public/Gemini_Generated_Image_iy5po1iy5po1iy5p.png" alt="Lt Col Piyush Sharma" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Lt Col</div>
                    <h3 class="rank-name">Piyush Sharma</h3>
                    <div class="rank-role">Second in Comd</div>
                    <a href="tel:9797719357" class="rank-phone">Mobile No: 9797719357</a>
                </div>
            </div>

            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">3</div>
                    <img src="public/Gemini_Generated_Image_kd3igrkd3igrkd3i%20%281%29.png" alt="Maj Harish Kumar" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Maj</div>
                    <h3 class="rank-name">Harish Kumar</h3>
                    <div class="rank-role">Adjt</div>
                    <a href="tel:9256172418" class="rank-phone">Mob No: 9256172418</a>
                </div>
            </div>

            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">4</div>
                    <img src="public/Col.jpg" alt="Lt Col Rahul T More" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Lt Col</div>
                    <h3 class="rank-name">Rahul T More</h3>
                    <div class="rank-role">OIC Tech Cell</div>
                    <a href="tel:7006216984" class="rank-phone">Mobile No: 7006216984</a>
                </div>
            </div>
        </div>
    </div>
    <div class="placeholder-section app-section hidden" id="section-settings">
        <h2>Settings</h2>
        <p>Settings section coming soon.</p>
    </div>
        </div>
    </div>
</body>
<script>
// Simple client-side router for left panel
document.querySelectorAll('.lp-nav li').forEach(item => {
  item.addEventListener('click', () => {
    // active state
    document.querySelectorAll('.lp-nav li').forEach(li => li.classList.remove('active'));
    item.classList.add('active');
    
    // show only the matching section
    const target = item.getAttribute('data-target');
    document.querySelectorAll('.app-section').forEach(sec => sec.classList.add('hidden'));
    const toShow = document.getElementById(target);
    if (toShow) toShow.classList.remove('hidden');
  });
});

// Families: render 50 demo cards
const familiesData = Array.from({ length: 50 }).map((_, i) => ({
  name: [
    'Anita Nirala','Anjali Devi','Archa A','Aruna Kumari','Babita Kumari','Barai Bhumeshwar D','Bulti Pradhan','Dipali Pawar','Divya Kumari','Goutami','Harsha Arvind','Haruli Devi','Hemlata Verma','Jayapriya S','Juhi Kumari','Jyoti Kuntal','Jyotsna Khatun','Kavita Sunil Shirke','Khushboo Verma','Meena Sharma'
  ][i % 20] + (i >= 20 ? ' ' + (i+1) : ''),
  husband: ['A K Nirala','C P Shukla','Akhil PA','K A Naidu','S K Singh','B Bhumeshwar D','Samir Pradhan','Pawar Sujit T','J P Kumar','A Suresh','Nithin Krishna R V','Vikram Singh','GP Verma','Velmurugan M','Sujit Kumar','Sunil Singh Kuntal','Hav Ismail Momin','Shirke S L','Mamta Saini','Rakesh Sharma'][i % 20],
  contact: '9' + String(100000000 + i * 3571).slice(0,9),
  education: ['12th','BA','BSC','10 + 2','MA'][i % 5],
  children: (i % 4) + ' children',
  joined: i % 3 === 0 ? 'Joined Apr ' + ((i % 28)+1) + ', 2024' : ''
}));

function renderFamilies() {
  const grid = document.getElementById('familiesGrid');
  if (!grid) return;
  grid.innerHTML = familiesData.map(f => `
    <div class="family-card">
      <div class="fc-top">
        <h4>${f.name}</h4>
        <span class="badge success">AWWA REGISTERED</span>
      </div>
      <div class="fc-body">
        <div class="row"><span class="label">Husband:</span><span class="val">${f.husband}</span></div>
        <div class="row"><span class="label">Contact:</span><span class="val">${f.contact}</span></div>
        <div class="row"><span class="label">Education:</span><span class="val">${f.education}</span></div>
      </div>
      <div class="fc-footer"><a href="#">${f.children}</a>${f.joined ? `<small>${f.joined}</small>` : ''}</div>
    </div>
  `).join('');
}

// Render when Families section becomes active once
const familiesNav = document.querySelector('.lp-nav li[data-target="section-families"]');
if (familiesNav) {
  familiesNav.addEventListener('click', () => {
    if (!document.getElementById('familiesGrid').dataset.rendered) {
      renderFamilies();
      document.getElementById('familiesGrid').dataset.rendered = 'true';
    }
  });
}

// COY: render military company data
const coyData = Array.from({ length: 24 }).map((_, i) => ({
  id: 'COY' + String(i + 1).padStart(3, '0'),
  femaleName: ['Priya Sharma','Kavita Singh','Sunita Verma','Rekha Patel','Meera Gupta','Anita Kumar','Sushila Yadav','Geeta Tiwari','Poonam Joshi','Ritu Agarwal','Neha Saxena','Deepa Mishra','Shilpa Jain','Rashmi Reddy','Kiran Nair','Vidya Rao','Suman Das','Lata Iyer','Mala Krishnan','Uma Menon','Shanti Pillai','Kamala Nair','Indira Raman','Sarojini Iyer'][i],
  spouseName: ['Rajesh Sharma','Vikram Singh','Amit Verma','Ravi Patel','Suresh Gupta','Raj Kumar','Vijay Yadav','Ramesh Tiwari','Sunil Joshi','Pradeep Agarwal','Anil Saxena','Manoj Mishra','Rakesh Jain','Kiran Reddy','Suresh Nair','Ravi Rao','Kumar Das','Rajan Iyer','Mohan Krishnan','Ravi Menon','Krishnan Pillai','Raman Nair','Suresh Raman','Ravi Iyer'][i],
  education: ['B.Tech','MBA','B.Sc','M.A','B.Com','M.Tech','B.A','M.Sc','B.E','M.Com','B.Ed','M.Ed','BBA','MBA','BDS','MDS','B.Pharm','M.Pharm','B.Sc Nursing','M.Sc Nursing','B.A','M.A','B.Tech','M.Tech'][i],
  phoneNumber: '+91-' + (9000000000 + i * 12345),
  rank: ['Col','Lt Col','Maj','Capt','Lt','Sqn Ldr','Flt Lt','Fg Offr','Wg Cdr','Gp Capt','Air Cmde','Air Vice Marshal'][i % 12]
}));

function renderCOY() {
  const grid = document.getElementById('coyGrid');
  if (!grid) return;
  grid.innerHTML = coyData.map(c => `
    <div class="family-card">
      <div class="fc-top">
        <h4>${c.id}</h4>
        <span class="badge success">${c.rank}</span>
      </div>
      <div class="fc-body">
        <div class="row"><span class="label">Female Name:</span><span class="val">${c.femaleName}</span></div>
        <div class="row"><span class="label">Spouse Name:</span><span class="val">${c.spouseName}</span></div>
        <div class="row"><span class="label">Education:</span><span class="val">${c.education}</span></div>
        <div class="row"><span class="label">Phone:</span><span class="val">${c.phoneNumber}</span></div>
      </div>
    </div>
  `).join('');
}

const coyNav = document.querySelector('.lp-nav li[data-target="section-companies"]');
if (coyNav) {
  coyNav.addEventListener('click', () => {
    const grid = document.getElementById('coyGrid');
    if (grid && !grid.dataset.rendered) {
      renderCOY();
      grid.dataset.rendered = 'true';
    }
  });
}

// Newsletter form submit and copy link
const newsletterForm = document.getElementById('newsletterForm');
if (newsletterForm) {
  newsletterForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('nlName').value.trim();
    const email = document.getElementById('nlEmail').value.trim();
    const message = document.getElementById('nlMessage');
    // Simulate successful subscription
    message.textContent = `Thanks, ${name || 'friend'}! A confirmation email was sent to ${email}.`;
    message.style.color = '#2ecc71';
    newsletterForm.reset();
  });
}

const copyBtn = document.getElementById('copyLinkBtn');
if (copyBtn) {
  copyBtn.addEventListener('click', async () => {
    const input = document.getElementById('nlShareLink');
    try {
      await navigator.clipboard.writeText(input.value);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => (copyBtn.innerHTML = '<i class="fas fa-copy"></i>'), 1200);
    } catch (_) {
      input.select();
      document.execCommand('copy');
      copyBtn.textContent = 'Copied!';
      setTimeout(() => (copyBtn.innerHTML = '<i class="fas fa-copy"></i>'), 1200);
    }
  });
}

// Power BI embed logic (publish-to-web URL stored in localStorage)
const pbiKey = 'awwa_pbi_embed_url';
const pbiUrlInput = document.getElementById('pbiUrl');
const pbiFrame = document.getElementById('pbiFrame');
const pbiLoadBtn = document.getElementById('pbiLoadBtn');
const pbiClearBtn = document.getElementById('pbiClearBtn');

function loadStoredPbi() {
  const url = localStorage.getItem(pbiKey);
  if (pbiUrlInput && url) pbiUrlInput.value = url;
  if (pbiFrame && url) pbiFrame.src = url;
}
loadStoredPbi();

if (pbiLoadBtn) {
  pbiLoadBtn.addEventListener('click', () => {
    const url = (pbiUrlInput?.value || '').trim();
    if (!url || !/^https:\/\/app\.powerbi\.com\/view/.test(url)) {
      alert('Please paste a valid Power BI "Publish to web" URL.');
      return;
    }
    localStorage.setItem(pbiKey, url);
    if (pbiFrame) pbiFrame.src = url;
  });
}

if (pbiClearBtn) {
  pbiClearBtn.addEventListener('click', () => {
    localStorage.removeItem(pbiKey);
    if (pbiUrlInput) pbiUrlInput.value = '';
    if (pbiFrame) pbiFrame.removeAttribute('src');
  });
}

// Charts: initialize on first view of dashboard
async function initChartsOnce() {
  if (window.__chartsReady) return;
  
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded');
    return;
  }
  
  const childrenCtx = document.getElementById('childrenClassChart');
  const healthCtx = document.getElementById('healthTreatmentChart');
  const occupationCtx = document.getElementById('occupationChart');
  const qualificationCtx = document.getElementById('qualificationChart');
  const ivfStartsCtx = document.getElementById('ivfStartsChart');
  const ivfStatusCtx = document.getElementById('ivfStatusChart');
  const specialVsNormalCtx = document.getElementById('specialVsNormalChart');
  const disabilityBreakdownCtx = document.getElementById('disabilityBreakdownChart');
  const maritalDiscordCtx = document.getElementById('maritalDiscordChart');
  const maritalDiscordTotalCtx = document.getElementById('maritalDiscordTotalChart');
  const familyCriticalCtx = document.getElementById('familyCriticalChart');
  const lowMedCatCtx = document.getElementById('lowMedCatChart');
  const lowMedCriticalPieCtx = document.getElementById('lowMedCriticalPie');
  
  // Proceed even if some canvases are missing; render what's available

  const brandPrimary = '#ff7a00';
  const brandSecondary = '#e86d00';
  const brandDark = '#21252b';

  // Try to fetch and parse the provided Excel to enrich charts
  async function loadWorkbookData() {
    try {
      const res = await fetch('public/Copy of ALL WKSP DATA.xlsx');
      if (!res.ok) return null;
      const arrayBuffer = await res.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      return workbook;
    } catch (e) {
      console.warn('Workbook load failed', e);
      return null;
    }
  }

  const workbook = await loadWorkbookData();
  let sheetData = {};
  if (workbook) {
    const firstSheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[firstSheetName];
    sheetData[firstSheetName] = XLSX.utils.sheet_to_json(ws, { defval: '' });
  }

  // Chart 1: Children by Class & Special Needs
  if (childrenCtx) new Chart(childrenCtx, {
    type: 'bar',
    data: {
      labels: ['Nursery', 'KG', 'Class 1-5', 'Class 6-8', 'Class 9-12', 'Special Needs'],
      datasets: [{
        label: 'Number of Children',
        data: (sheetData.childrenByClassCounts || [45,38,92,78,65,12]),
        backgroundColor: [brandPrimary, brandSecondary, brandDark, '#ff9f40', '#ff6b6b', '#9b59b6'],
        borderColor: '#fff',
        borderWidth: 2,
        hoverBackgroundColor: ['#e86d00', '#e68600', '#d55a00', '#e68a2c', '#e55a5a', '#8a4db8'],
        hoverBorderColor: ['#d55a00', '#d57500', '#c54900', '#d67a1c', '#d54949', '#7a3da8']
      }]
    },
    options: {
      responsive: true,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: { 
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: brandPrimary,
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label + ' Category';
            },
            label: function(context) {
              const value = context.parsed.y;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${value} children (${percentage}%)`;
            }
          }
        },
        // Draw value labels on bars
        datalabels: false
      },
      scales: { 
        y: { 
          beginAtZero: true,
          grid: { color: '#f0f0f0' },
          ticks: {
            color: '#5a6c7d',
            font: { weight: '600' }
          }
        },
        x: { 
          grid: { display: false },
          ticks: {
            color: '#5a6c7d',
            font: { weight: '600' }
          }
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeInOutQuart'
      }
    }
  });

  // Chart 2: Family Health & Treatment Cases
  if (healthCtx) new Chart(healthCtx, {
    type: 'doughnut',
    data: {
      labels: ['No Health Issues', 'Minor Ailments', 'Chronic Diseases', 'Emergency Cases', 'Treatment Ongoing'],
      datasets: [{
        data: [180, 65, 23, 4, 2],
        backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c', '#9b59b6', '#3498db'],
        borderColor: '#fff',
        borderWidth: 3
      }]
    },
    options: {
      plugins: { legend: { position: 'bottom' } },
      cutout: '50%'
    }
  });

  // Chart 3: Husband & Ladies Occupation
  if (occupationCtx) new Chart(occupationCtx, {
    type: 'bar',
    data: {
      labels: ['Military Officer', 'Government Service', 'Private Sector', 'Business', 'Homemaker', 'Teacher', 'Medical', 'Other'],
      datasets: [{
        label: 'Husband',
        data: [45, 38, 42, 28, 0, 12, 8, 15],
        backgroundColor: brandPrimary,
        borderColor: '#fff',
        borderWidth: 1
      }, {
        label: 'Ladies',
        data: [0, 25, 35, 15, 45, 28, 18, 22],
        backgroundColor: brandSecondary,
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { position: 'top' } },
      scales: { 
        y: { beginAtZero: true },
        x: { grid: { display: false } }
      }
    }
  });

  // Chart 4: Qualification & Joining Date
  if (qualificationCtx) new Chart(qualificationCtx, {
    type: 'line',
    data: {
      labels: ['2019', '2020', '2021', '2022', '2023', '2024'],
      datasets: [{
        label: 'New Joinings',
        data: [25, 35, 42, 38, 45, 28],
        borderColor: brandPrimary,
        backgroundColor: brandPrimary + '20',
        tension: 0.4,
        fill: true
      }, {
        label: 'Graduates',
        data: [15, 22, 28, 35, 42, 38],
        borderColor: brandSecondary,
        backgroundColor: brandSecondary + '20',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true } }
    }
  });

  // Chart 5: IVF Starts per Month
  if (ivfStartsCtx) new Chart(ivfStartsCtx, {
    type: 'bar',
    data: {
      labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      datasets: [{
        label: 'IVF Start Cases',
        data: (sheetData.ivfStartsByMonth || [0,1,0,2,3,1,0,2,1,0,1,2]),
        backgroundColor: brandPrimary,
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // Chart 6: IVF Treatment Status
  if (ivfStatusCtx) new Chart(ivfStatusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Ongoing', 'Completed', 'Nil/Not Started'],
      datasets: [{
        data: (sheetData.ivfStatusCounts || [4,2,18]),
        backgroundColor: ['#3498db', '#2ecc71', '#e9edf5'],
        borderColor: '#fff',
        borderWidth: 3
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } }, cutout: '55%' }
  });

  // Chart 7: Special Child vs Normal Medical Cases (from sheet snapshot)
  if (specialVsNormalCtx) new Chart(specialVsNormalCtx, {
    type: 'bar',
    data: {
      labels: (sheetData.coys || ['832 Coy','265 Coy','290 Coy','831 Coy','286 Coy','288 Coy']),
      datasets: [{
        label: 'Special Child',
        data: (sheetData.specialChildCounts || [0,0,0,1,2,0]),
        backgroundColor: '#9b59b6'
      },{
        label: 'Normal Medical Problem',
        data: (sheetData.normalMedCounts || [0,0,0,0,0,0]),
        backgroundColor: '#95a5a6'
      }]
    },
    options: { plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
  });

  // Chart 8: Special Child ‚Äì Disability Breakdown
  if (disabilityBreakdownCtx) new Chart(disabilityBreakdownCtx, {
    type: 'doughnut',
    data: {
      labels: (sheetData.disabilityLabels || ['Autism Spectrum','Cleft Palate/Neck/Septum']),
      datasets: [{
        data: (sheetData.disabilityCounts || [1,1]),
        backgroundColor: ['#e74c3c','#f39c12'],
        borderColor: '#fff',
        borderWidth: 3
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } }, cutout: '55%' }
  });

  // Chart 9: Marital Discord ‚Äì Official vs Not Official per COY
  if (maritalDiscordCtx) new Chart(maritalDiscordCtx, {
    type: 'bar',
    data: {
      labels: (sheetData.coys || ['832 Coy','265 Coy','290 Coy','831 Coy']),
      datasets: [{
        label: 'Official Registered',
        data: (sheetData.maritalOfficial || [2,0,0,2]),
        backgroundColor: brandPrimary
      }, {
        label: 'Not Official Registered',
        data: (sheetData.maritalUnofficial || [0,0,0,0]),
        backgroundColor: '#95a5a6'
      }]
    },
    options: { plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
  });

  // Chart 10: Marital Discord ‚Äì Total Breakdown
  if (maritalDiscordTotalCtx) new Chart(maritalDiscordTotalCtx, {
    type: 'doughnut',
    data: {
      labels: ['Official Registered','Not Official Registered'],
      datasets: [{
        data: [ (sheetData.maritalOfficial?.reduce?.((a,b)=>a+b,0) ?? 4), (sheetData.maritalUnofficial?.reduce?.((a,b)=>a+b,0) ?? 0) ],
        backgroundColor: [brandPrimary, '#e9edf5'],
        borderColor: '#fff',
        borderWidth: 3
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } }, cutout: '55%' }
  });

  // Chart 11: Family Critical Medical Problem (Nil or count)
  if (familyCriticalCtx) new Chart(familyCriticalCtx, {
    type: 'bar',
    data: {
      labels: (sheetData.coys || ['All Coys']),
      datasets: [{
        label: 'Critical Medical Cases',
        data: (sheetData.familyCriticalCounts || [0]),
        backgroundColor: '#e74c3c'
      }]
    },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // Chart 12: Low Medical Category ‚Äì Present Med Cat distribution
  if (lowMedCatCtx) new Chart(lowMedCatCtx, {
    type: 'bar',
    data: {
      labels: (sheetData.lowMedLabels || ['P2','P3','P4']),
      datasets: [{
        label: 'Personnel Count',
        data: (sheetData.lowMedCounts || [8,12,5]),
        backgroundColor: [brandPrimary, brandSecondary, '#9b59b6']
      }]
    },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // Chart 13: Low Med ‚Äì Critical vs Normal cases
  if (lowMedCriticalPieCtx) new Chart(lowMedCriticalPieCtx, {
    type: 'doughnut',
    data: {
      labels: ['Critical', 'Normal'],
      datasets: [{
        data: (sheetData.lowMedCriticalSplit || [6, 19]),
        backgroundColor: ['#e74c3c', '#2ecc71'],
        borderColor: '#fff',
        borderWidth: 3
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } }, cutout: '55%' }
  });

  // Dynamic Analytics and Insights
  function updateAnalytics() {
    // Fixed data values
    const fixedData = {
      totalFamilies: 273,
      ivfCases: 6,
      specialChildCases: 12,
      criticalCases: 8
    };

    // Update DOM elements with fixed data
    document.getElementById('totalFamilies').textContent = fixedData.totalFamilies.toLocaleString();
    document.getElementById('ivfCases').textContent = fixedData.ivfCases;
    document.getElementById('specialChildCases').textContent = fixedData.specialChildCases;
    document.getElementById('criticalCases').textContent = fixedData.criticalCases;

    // Update mini cards with fixed data
    const minis = document.querySelectorAll('.mini-value');
    if (minis[0]) minis[0].textContent = fixedData.totalFamilies.toLocaleString();
    if (minis[1]) minis[1].textContent = '485'; // Total children
    if (minis[2]) minis[2].textContent = fixedData.totalFamilies.toLocaleString(); // Registered families
    if (minis[3]) minis[3].textContent = '1.8'; // Avg children per family

    // Update icon badges with fixed data
    const badgeFamilies = document.getElementById('badgeFamilies');
    const badgeChildren = document.getElementById('badgeChildren');
    const badgeRegistered = document.getElementById('badgeRegistered');
    const badgeAvg = document.getElementById('badgeAvg');
    if (badgeFamilies) badgeFamilies.textContent = fixedData.totalFamilies;
    if (badgeChildren) badgeChildren.textContent = '485';
    if (badgeRegistered) badgeRegistered.textContent = fixedData.totalFamilies;
    if (badgeAvg) badgeAvg.textContent = '1.8';

    // Update KPI cards if present
    const famKpi = document.getElementById('totalFamiliesKPI');
    if (famKpi) famKpi.textContent = fixedData.totalFamilies.toLocaleString();
  }
  
  function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    const sign = change >= 0 ? '+' : '';
    element.textContent = `${sign}${change}%`;
    element.className = `insight-change ${change >= 0 ? 'positive' : 'negative'}`;
  }
  
  // Filters with real data filtering
  const filterCoy = document.getElementById('filterCoy');
  const filterYear = document.getElementById('filterYear');
  
  function applyFilters() {
    const coy = filterCoy?.value || 'all';
    const yr = filterYear?.value || 'all';
    
    // Filter data based on selections
    let filteredData = sheetData || [];
    
    if (coy !== 'all') {
      // Filter by COY if column exists in Excel
      filteredData = filteredData.filter(row => 
        row.COY === coy || row.Company === coy || row.Unit === coy
      );
    }
    
    if (yr !== 'all') {
      // Filter by year if date column exists
      filteredData = filteredData.filter(row => {
        const dateStr = row.Date || row.Joining_Date || row.Registration_Date;
        return dateStr && dateStr.toString().includes(yr);
      });
    }
    
    // Update chips
    const chipCoy = document.getElementById('chipCoy');
    const chipYear = document.getElementById('chipYear');
    if (chipCoy) { chipCoy.style.display = (coy==='all')? 'none' : 'inline-flex'; chipCoy.textContent = coy; }
    if (chipYear) { chipYear.style.display = (yr==='all')? 'none' : 'inline-flex'; chipYear.textContent = yr; }

    // Update subtitles
    const scope = `${coy === 'all' ? 'All COYs' : coy} ¬∑ ${yr === 'all' ? 'All Years' : yr}`;
    const setSub = (id) => { const el = document.getElementById(id); if (el) el.textContent = scope; };
    setSub('sub-children'); setSub('sub-health'); setSub('sub-occupation');

    // Update analytics with filtered data
    updateAnalyticsWithData(filteredData);
    
    // Re-render charts with filtered data
    reRenderCharts(filteredData);
  }
  
  function updateAnalyticsWithData(data) {
    const m = deriveMetrics(data);
    document.getElementById('totalFamilies').textContent = m.totalFamilies.toLocaleString();
    document.getElementById('ivfCases').textContent = m.ivfCases;
    document.getElementById('specialChildCases').textContent = m.specialChildCases;
    document.getElementById('criticalCases').textContent = m.criticalCases;

    const minis = document.querySelectorAll('.mini-value');
    if (minis[0]) minis[0].textContent = m.totalFamilies.toLocaleString();
    if (minis[1]) minis[1].textContent = m.totalChildren.toLocaleString();
    if (minis[2]) minis[2].textContent = m.registeredFamilies.toLocaleString();
    if (minis[3]) minis[3].textContent = m.avgChildrenPerFamily.toFixed(1);

    const badgeFamilies = document.getElementById('badgeFamilies');
    const badgeChildren = document.getElementById('badgeChildren');
    const badgeRegistered = document.getElementById('badgeRegistered');
    const badgeAvg = document.getElementById('badgeAvg');
    if (badgeFamilies) badgeFamilies.textContent = m.totalFamilies;
    if (badgeChildren) badgeChildren.textContent = m.totalChildren;
    if (badgeRegistered) badgeRegistered.textContent = m.registeredFamilies;
    if (badgeAvg) badgeAvg.textContent = m.avgChildrenPerFamily.toFixed(1);

    const famKpi = document.getElementById('totalFamiliesKPI');
    if (famKpi) famKpi.textContent = m.totalFamilies.toLocaleString();
  }

  // Heuristic metrics extractor for Army dataset
  function deriveMetrics(rows) {
    const totalFamilies = rows.length || 0;

    // Registered flag guess
    const registeredFamilies = rows.filter(r =>
      ['Registered','IsRegistered','REGD','Regd','REG','Registered_Flag']
        .some(k => r[k] === 'Yes' || r[k] === 'Y' || r[k] === '1' || r[k] === 1)
    ).length || totalFamilies;

    // Children count guess
    let totalChildren = 0;
    rows.forEach(r => {
      // Explicit count columns
      const explicitKeys = ['Children','Children_Count','No_of_Children','Num_Children','Child_Count'];
      for (const k of explicitKeys) {
        if (r[k] != null && !isNaN(Number(r[k]))) { totalChildren += Number(r[k]); return; }
      }
      // Sum numeric fields whose key mentions child
      const childLike = Object.keys(r).filter(k => /child/i.test(k) && !isNaN(Number(r[k])));
      if (childLike.length) {
        totalChildren += childLike.reduce((s,k)=> s + Number(r[k]||0), 0);
      }
    });

    // IVF / Special / Critical flags
    const ivfCases = rows.filter(r => r.IVF === 'Yes' || r.Treatment_Type === 'IVF' || r.Case_Type === 'IVF').length;
    const specialChildCases = rows.filter(r => r.Special_Child === 'Yes' || r.Disability === 'Yes' || r.Special_Needs === 'Yes').length;
    const criticalCases = rows.filter(r => r.Critical === 'Yes' || r.Medical_Category === 'Critical' || r.Priority === 'High').length;

    const avgChildrenPerFamily = totalFamilies ? (totalChildren / totalFamilies) : 0;

    return { totalFamilies, registeredFamilies, totalChildren, avgChildrenPerFamily, ivfCases, specialChildCases, criticalCases };
  }
  
  function reRenderCharts(filteredData) {
    // Helper: destroy existing chart on a canvas id if present
    function resetChart(canvasId) {
      const cv = document.getElementById(canvasId);
      if (!cv) return null;
      if (cv._chart) {
        try { cv._chart.destroy(); } catch (e) {}
      }
      return cv;
    }

    // Baselines used if we cannot compute exact series from Excel
    const baseline = {
      childrenByClass: [45, 38, 92, 78, 65, 12],
      healthDonut: [180, 65, 23, 4, 2],
      husband: [45, 38, 42, 28, 0, 12, 8, 15],
      ladies: [0, 25, 35, 15, 45, 28, 18, 22]
    };

    // Compute factor relative to all rows so charts scale with filter
    const firstSheet = (sheetData && Object.keys(sheetData)[0]) || null;
    const totalRows = firstSheet ? sheetData[firstSheet].length : 150;
    const factor = totalRows > 0 ? (filteredData.length / totalRows) : 1;

    // 1) Children by Class chart
    const childrenCv = resetChart('childrenClassChart');
    if (childrenCv) {
      const scaled = baseline.childrenByClass.map(v => Math.max(0, Math.round(v * factor)));
      childrenCv._chart = new Chart(childrenCv, {
        type: 'bar',
        data: {
          labels: ['Nursery', 'KG', 'Class 1-5', 'Class 6-8', 'Class 9-12', 'Special Needs'],
          datasets: [{
            label: 'Number of Children',
            data: scaled,
            backgroundColor: [brandPrimary, brandSecondary, brandDark, '#ff9f40', '#ff6b6b', '#9b59b6'],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
      });
    }

    // 2) Health & Treatment donut
    const healthCv = resetChart('healthTreatmentChart');
    if (healthCv) {
      const scaled = baseline.healthDonut.map(v => Math.max(0, Math.round(v * factor)));
      healthCv._chart = new Chart(healthCv, {
        type: 'doughnut',
        data: { labels: ['No Health Issues', 'Minor Ailments', 'Chronic Diseases', 'Emergency Cases', 'Treatment Ongoing'], datasets: [{ data: scaled, backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c', '#9b59b6', '#3498db'], borderColor: '#fff', borderWidth: 3 }] },
        options: { plugins: { legend: { position: 'bottom' } }, cutout: '50%' }
      });
    }

    // 3) Occupation stacked bars
    const occCv = resetChart('occupationChart');
    if (occCv) {
      const hus = baseline.husband.map(v => Math.max(0, Math.round(v * factor)));
      const lad = baseline.ladies.map(v => Math.max(0, Math.round(v * factor)));
      occCv._chart = new Chart(occCv, {
        type: 'bar',
        data: {
          labels: ['Military Officer', 'Government Service', 'Private Sector', 'Business', 'Homemaker', 'Teacher', 'Medical', 'Other'],
          datasets: [{ label: 'Husband', data: hus, backgroundColor: brandPrimary, borderColor: '#fff', borderWidth: 1 }, { label: 'Ladies', data: lad, backgroundColor: brandSecondary, borderColor: '#fff', borderWidth: 1 }]
        },
        options: { plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
      });
    }

    // You can extend with more charts similarly if needed
  }
  
  // Initialize analytics
  updateAnalytics();
  
  // Add event listeners
  filterCoy?.addEventListener('change', applyFilters);
  filterYear?.addEventListener('change', applyFilters);

  // KPI click -> focus chart
  document.querySelectorAll('.kpi-click').forEach(card => {
    card.addEventListener('click', () => {
      const targetId = card.getAttribute('data-target');
      const kind = card.getAttribute('data-kind');
      const canvas = document.getElementById(targetId);
      if (!canvas) return;
      // Alt-click opens drilldown
      if (window.event && window.event.altKey && kind) {
        openDrilldown(kind);
        return;
      }
      const cardWrap = canvas.closest('.chart-card');
      if (cardWrap) {
        cardWrap.classList.add('chart-flash');
        cardWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => cardWrap.classList.remove('chart-flash'), 1200);
      }
    });
  });
  
  // Auto-refresh analytics every 30 seconds
  setInterval(updateAnalytics, 30000);
  
  // Real-time data simulation
  function simulateRealTimeData() {
    // Simulate live data updates
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    
    // Update time display if exists
    const timeElement = document.getElementById('lastUpdateTime');
    if (timeElement) {
      timeElement.textContent = `Last updated: ${timeStr}`;
    }
    
    // Simulate small data fluctuations
    const fluctuation = () => Math.floor(Math.random() * 6) - 3; // -3 to +3
    
    // Update mini cards with slight variations
    const miniValues = document.querySelectorAll('.mini-value');
    miniValues.forEach((element, index) => {
      const currentValue = parseInt(element.textContent.replace(/,/g, ''));
      const newValue = Math.max(0, currentValue + fluctuation());
      element.textContent = newValue.toLocaleString();
    });
    
    // Add pulse animation to indicate live updates
    document.querySelectorAll('.insight-card').forEach(card => {
      card.style.animation = 'pulse 0.5s ease-in-out';
      setTimeout(() => {
        card.style.animation = '';
      }, 500);
    });
  }
  
  // Add live update indicator
  function addLiveIndicator() {
    const liveIndicator = document.createElement('div');
    liveIndicator.id = 'liveIndicator';
    liveIndicator.innerHTML = `
      <div class="live-dot"></div>
      <span>Live Data</span>
    `;
    liveIndicator.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
    `;
    
    const liveDot = liveIndicator.querySelector('.live-dot');
    liveDot.style.cssText = `
      width: 8px;
      height: 8px;
      background: #fff;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    `;
    
    document.body.appendChild(liveIndicator);
  }
  
  // Add CSS for animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    .chart-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    
    .insight-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      transition: all 0.3s ease;
    }
  `;
  document.head.appendChild(style);

  // Simple on-canvas value labels plugin for clarity
  Chart.register({
    id: 'valueLabels',
    afterDatasetsDraw(chart, args, opts) {
      const { ctx } = chart;
      chart.data.datasets.forEach((dataset, i) => {
        const meta = chart.getDatasetMeta(i);
        if (!meta || meta.hidden) return;
        meta.data.forEach((element, index) => {
          const val = dataset.data[index];
          if (val == null) return;
          const pos = element.tooltipPosition();
          ctx.save();
          ctx.font = '600 11px system-ui, -apple-system, Segoe UI';
          ctx.fillStyle = '#2c3e50';
          ctx.textAlign = 'center';
          const y = Math.min(pos.y - 8, element.y - 8);
          ctx.fillText(String(val), pos.x, y);
          ctx.restore();
        });
      });
    }
  });
  
  // Initialize live features
  addLiveIndicator();
  setInterval(simulateRealTimeData, 10000); // Update every 10 seconds

  // Draw KPI sparklines using Chart.js lightweight configs
  function drawSparkline(id, data, color) {
    const cv = document.getElementById(id);
    if (!cv) return;
    if (cv._chart) { try { cv._chart.destroy(); } catch (e) {} }
    cv._chart = new Chart(cv, {
      type: 'line',
      data: { labels: data.map((_, i) => i + 1), datasets: [{ data, borderColor: color, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.35 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
    });
  }
  drawSparkline('sparkFamilies', [210, 220, 230, 235, 245, 260, 274], '#3b82f6');
  drawSparkline('sparkIVF', [62, 65, 70, 72, 75, 77, 78], '#ef6c00');
  drawSparkline('sparkSpecial', [88, 90, 91, 92, 92, 92, 92], '#9c27b0');
  drawSparkline('sparkCritical', [70, 72, 73, 76, 79, 83, 85], '#16a34a');

  // Drilldown logic
  const drillModal = document.getElementById('drilldownModal');
  const drillTitle = document.getElementById('drillTitle');
  const drillThead = document.getElementById('drillThead');
  const drillTbody = document.getElementById('drillTbody');
  const drillSearch = document.getElementById('drillSearch');
  const drillCount = document.getElementById('drillCount');
  const drillClose = document.getElementById('drillClose');
  let drillRows = [];

  function openDrilldown(kind) {
    const coy = filterCoy?.value || 'all';
    const yr = filterYear?.value || 'all';
    let filtered = (sheetData && Object.values(sheetData)[0]) || [];
    if (coy !== 'all') filtered = filtered.filter(r => r.COY === coy || r.Company === coy || r.Unit === coy);
    if (yr !== 'all') filtered = filtered.filter(r => {
      const ds = r.Date || r.Joining_Date || r.Registration_Date;
      return ds && ds.toString().includes(yr);
    });

    if (kind === 'ivf') filtered = filtered.filter(r => r.IVF === 'Yes' || r.Treatment_Type === 'IVF' || r.Case_Type === 'IVF');
    if (kind === 'special') filtered = filtered.filter(r => r.Special_Child === 'Yes' || r.Disability === 'Yes' || r.Special_Needs === 'Yes');
    if (kind === 'critical') filtered = filtered.filter(r => r.Critical === 'Yes' || r.Medical_Category === 'Critical' || r.Priority === 'High');

    const columns = ['Family_ID','Name','Spouse_Name','Phone','COY','Unit','Registration_Date','Case_Type','Treatment_Type','Special_Child','Medical_Category'];
    drillTitle.textContent = kind === 'ivf' ? 'IVF Cases' : kind === 'special' ? 'Special Child Cases' : kind === 'critical' ? 'Critical Medical Cases' : 'Families';
    drillThead.innerHTML = `<tr>${columns.map(c=>`<th>${c.replaceAll('_',' ')}</th>`).join('')}</tr>`;
    drillRows = filtered.map(r => columns.map(c => r[c] ?? ''));
    renderDrillRows(drillRows);
    drillModal.style.display = 'flex';
  }

  function renderDrillRows(rows) {
    drillTbody.innerHTML = rows.map(r => `<tr>${r.map(v => `<td>${String(v)}</td>`).join('')}</tr>`).join('');
    drillCount.textContent = `${rows.length} rows`;
  }

  drillClose?.addEventListener('click', ()=> drillModal.style.display='none');
  drillModal?.addEventListener('click', (e)=>{ if (e.target === drillModal) drillModal.style.display='none'; });
  drillSearch?.addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase();
    const filtered = drillRows.filter(r => r.some(v => String(v).toLowerCase().includes(q)));
    renderDrillRows(filtered);
  });

  window.__chartsReady = true;
}

// Initialize charts when dashboard is shown
const dashNav = document.querySelector('.lp-nav li[data-target="section-dashboard"]');
if (dashNav) {
  dashNav.addEventListener('click', initChartsOnce);
}

// Initialize charts after page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initChartsOnce, 1000);
});

// Also try on window load
window.addEventListener('load', function() {
  setTimeout(initChartsOnce, 500);
});

// Load personalized user information
function loadUserInfo() {
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    
    if (userInfo.name) {
        // Update welcome title
        document.getElementById('welcomeTitle').textContent = `Welcome, ${userInfo.name}!`;
        
        // Update profile information
        document.getElementById('profileName').textContent = userInfo.name;
        document.getElementById('profileDesignation').textContent = userInfo.designation || 'User';
        
        // Update profile initials
        const initials = userInfo.name.split(' ').map(n => n[0]).join('').toUpperCase();
        document.getElementById('profileInitials').textContent = initials;
        
        // Set profile image based on user
        let profileImage = 'public/profile.png'; // default
        switch(userInfo.userId) {
            case 'tarunpreet singh':
                profileImage = 'public/Gemini_Generated_Image_4jitd24jitd24jit.png';
                break;
            case 'piyush sharma':
                profileImage = 'public/Gemini_Generated_Image_iy5po1iy5po1iy5p.png';
                break;
            case 'harish kumar':
                profileImage = 'public/Gemini_Generated_Image_kd3igrkd3igrkd3i%20%281%29.png';
                break;
            case 'rahul t more':
                profileImage = 'public/Col.jpg';
                break;
            case 'bt01':
                profileImage = 'public/profile.png';
                break;
            default:
                profileImage = 'public/profile.png';
        }
        
        // Update profile images
        const profileImages = document.querySelectorAll('.avatar-box-img, .lp-avatar-img');
        profileImages.forEach(img => {
            img.src = profileImage;
        });
        
        // Update user information panel
        const userInfoBody = document.getElementById('userInfoBody');
        userInfoBody.innerHTML = `
            <div class="info-row"><span class="label">User ID:</span><span class="value">${userInfo.userId}</span></div>
            <div class="info-row"><span class="label">Name:</span><span class="value">${userInfo.name}</span></div>
            <div class="info-row"><span class="label">Designation:</span><span class="value">${userInfo.designation || 'N/A'}</span></div>
            <div class="info-row"><span class="label">Contact Number:</span><span class="value">${userInfo.phone || 'N/A'}</span></div>
            <div class="info-row"><span class="label">User Type:</span><span class="value">${userInfo.userType || 'admin'}</span></div>
        `;
        
        // Update left panel name
        const leftPanelName = document.querySelector('.lp-name');
        if (leftPanelName) {
            leftPanelName.textContent = userInfo.name;
        }
        
        // Update left panel role
        const leftPanelRole = document.querySelector('.lp-role');
        if (leftPanelRole) {
            leftPanelRole.textContent = userInfo.designation || 'User';
        }
    }
}

// Load user info when page loads
document.addEventListener('DOMContentLoaded', loadUserInfo);

// Logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('userInfo');
        window.location.href = 'index.html';
    }
}

// Populate top KPIs from workbook if available
document.addEventListener('DOMContentLoaded', () => {
  const totals = sheetData?.totals || null;
  if (!totals) return;
  const el = (id, val) => { const d = document.getElementById(id); if (d && val != null) d.textContent = val; };
  el('totalFamiliesVal', totals.totalFamilies);
  el('totalChildrenVal', totals.totalChildren);
  el('registeredFamiliesVal', totals.registeredFamilies ?? totals.totalFamilies);
  if (totals.totalFamilies && totals.totalChildren != null) {
    el('avgChildrenVal', (totals.totalChildren / totals.totalFamilies).toFixed(1));
  }
});

</script>

<!-- D-ID Chatbot -->
<script type="module"
      src="https://agent.d-id.com/v2/index.js"
      data-mode="fabio"
      data-client-key="Z29vZ2xlLW9hdXRoMnwxMDA1MjIwMjc4MDA4MjIzNDk5MDE6aDEyZUd2MFNUa2gzWkRhWG0ybjA2"
      data-agent-id="v2_agt_CKSD5djL"
      data-name="did-agent"
      data-monitor="true"
      data-orientation="horizontal"
      data-position="right">
</script>

<!-- Fallback chatbot if D-ID doesn't load -->
<div id="chatbot-fallback" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: none;">
    <button onclick="toggleFallbackChat()" style="background: #ff7a00; color: white; border: none; padding: 15px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer;">
        <i class="fas fa-comments" style="font-size: 20px;"></i>
    </button>
</div>

<script>
    // Check if D-ID chatbot loads, show fallback if not
    setTimeout(() => {
        if (!document.querySelector('[data-name="did-agent"]')) {
            document.getElementById('chatbot-fallback').style.display = 'block';
        }
    }, 3000);
    
    function toggleFallbackChat() {
        alert('Chatbot is temporarily unavailable. Please contact support for assistance.');
    }
</script>
</html>

